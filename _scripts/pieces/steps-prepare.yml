- uses: actions/checkout@v3
  with:
      ref: "master"

- uses: cachix/install-nix-action@v17
  with:
      nix_path: "nixpkgs=channel:nixpkgs-unstable"
      # Need manually sed /etc/nix/nix.conf to
      # add extra-sandbox-paths since invoking
      # nix happens before setup ccache dirs,
      # which makes nix angry.

- name: "Install tools"
  run: |
      nix-env -f '<nixpkgs>' -iA \
        'nix-build-uncached' 'fish' 'rsync'

- uses: actions/cache@v3
  with:
      path: ~/ccache
      key: ccaches-seg01-${{ github.job }}-${{ github.sha }}
      restore-keys: |
          ccaches-seg01--${{ github.job }}-

- name: "Setup ccache for nix"
  run: |
      fish _scripts/ccache.fish setup

- name: "Change TMPDIR for nix daemon"
  run: |
      fish _scripts/set-tmpdir.fish

- name: "Update flake"
  run: |
      nix flake update

- uses: cachix/cachix-action@v10
  with:
      name: "nuirrce"
      authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      cachixArgs: "-j8 -c5"
      pushFilter: |
          (NVIDIA.*\.run)|(-source|vendor\.tar\.gz)|(ccache|stdenv)

